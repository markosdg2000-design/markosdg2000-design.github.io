<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventario QR R√°pido</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#111;color:#fff}
    header{padding:12px 14px;background:#1b1b1b;position:sticky;top:0;z-index:10}
    .wrap{padding:12px;display:grid;gap:10px;padding-bottom:96px}
    input,button{font-size:18px;padding:12px;border-radius:10px;border:1px solid #333}
    input{width:100%;background:#0b0b0b;color:#fff}
    button{background:#2b6cff;color:#fff;border:none;font-weight:900;cursor:pointer}
    button.secondary{background:#333}
    .card{background:#1b1b1b;border:1px solid #2a2a2a;border-radius:14px;padding:12px}
    .muted{color:#bbb}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1;min-width:140px}
    .status{font-size:14px;color:#bbb;margin-top:10px}
    .scanBig{font-size:22px;padding:16px;border-radius:14px}
    .hint{font-size:12px;color:#9a9a9a}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0b0b0b;border:1px solid #2a2a2a;color:#bbb;font-size:12px}

    #reader{width:100%;border-radius:14px;overflow:hidden}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid #2a2a2a;padding:8px;text-align:left}
    th{color:#bbb;font-weight:700}

    .footerAction{
      position:fixed;
      left:12px;
      right:12px;
      bottom:14px;
      z-index:20;
      border-radius:999px;
      font-size:20px;
      box-shadow:0 8px 30px rgba(43,108,255,.35);
    }

    .modalWrap{
      position:fixed;inset:0;background:rgba(0,0,0,.65);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:30;
    }
    .modal{
      width:min(520px,100%);
      background:#1b1b1b;border:1px solid #2a2a2a;border-radius:16px;padding:14px;
      display:grid;gap:10px;
    }
    .modal h3{margin:0 0 4px 0}
  </style>
</head>
<body>
  <header>
    <strong>Inventario QR R√°pido</strong>
    <div class="muted">Escaneo continuo + registro inmediato</div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="row" style="align-items:center;">
        <span class="pill" id="scanState">Esc√°ner iniciando‚Ä¶</span>
        <span class="pill">Registros: <strong id="totalRegistros">0</strong></span>
      </div>
      <p class="hint">El lector permanece abierto. Al detectar un QR, se abre un formulario para completar cantidad y n√∫mero de serie.</p>
      <div id="reader"></div>
      <div class="status" id="status">Preparando c√°mara‚Ä¶</div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">Tabla temporal</h3>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>C√≥digo componente</th>
              <th>Cantidad</th>
              <th>N¬∫ serie destino</th>
              <th>Fecha/hora</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <button class="footerAction" id="mailBtn">üìß Enviar inventario por mail</button>

  <div class="modalWrap" id="modalWrap" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Registrar material escaneado</h3>
      <div class="muted" id="codigoDetectado"></div>
      <label>
        Cantidad
        <input id="cantidadInput" type="number" min="1" step="1" placeholder="Ej. 10" />
      </label>
      <label>
        N¬∫ de serie destino
        <input id="serieInput" type="text" placeholder="Ej. SN-2026-001" />
      </label>
      <div class="row">
        <button class="secondary" id="cancelBtn" type="button">Cancelar</button>
        <button id="guardarBtn" type="button">Registrar</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/html5-qrcode" defer></script>
  <script>
    const registros = [];
    let ultimoCodigo = '';
    let ultimoMomento = 0;
    let codigoPendiente = null;
    let modalAbierta = false;

    const $ = (id) => document.getElementById(id);
    const tbody = $('tbody');
    const totalRegistros = $('totalRegistros');
    const statusEl = $('status');
    const scanState = $('scanState');

    function fmtDate(d) {
      return new Intl.DateTimeFormat('es-ES', { dateStyle: 'short', timeStyle: 'medium' }).format(d);
    }

    function actualizarTabla() {
      tbody.innerHTML = '';
      registros.forEach((r, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${r.codigo}</td>
          <td>${r.cantidad}</td>
          <td>${r.serie}</td>
          <td>${r.fecha}</td>
        `;
        tbody.appendChild(tr);
      });
      totalRegistros.textContent = registros.length;
    }

    function abrirModal(codigo) {
      modalAbierta = true;
      codigoPendiente = codigo;
      $('codigoDetectado').textContent = `C√≥digo detectado: ${codigo}`;
      $('cantidadInput').value = '';
      $('serieInput').value = '';
      $('modalWrap').style.display = 'flex';
      $('modalWrap').setAttribute('aria-hidden', 'false');
      $('cantidadInput').focus();
    }

    function cerrarModal() {
      modalAbierta = false;
      codigoPendiente = null;
      $('modalWrap').style.display = 'none';
      $('modalWrap').setAttribute('aria-hidden', 'true');
      statusEl.textContent = 'Esc√°ner activo. Esperando siguiente QR‚Ä¶';
    }

    $('cancelBtn').addEventListener('click', cerrarModal);

    $('guardarBtn').addEventListener('click', () => {
      const cantidad = Number($('cantidadInput').value);
      const serie = $('serieInput').value.trim();

      if (!codigoPendiente) return;
      if (!cantidad || cantidad <= 0) {
        alert('Introduce una cantidad v√°lida mayor que 0.');
        return;
      }
      if (!serie) {
        alert('Introduce el n√∫mero de serie destino.');
        return;
      }

      registros.push({
        codigo: codigoPendiente,
        cantidad,
        serie,
        fecha: fmtDate(new Date())
      });

      actualizarTabla();
      cerrarModal();
    });

    function recortarTexto(valor, max = 30) {
      const txt = String(valor ?? '');
      return txt.length > max ? `${txt.slice(0, max - 1)}‚Ä¶` : txt;
    }

    function generarTablaTexto() {
      const headers = ['#', 'C√≥digo componente', 'Cantidad', 'N¬∫ serie destino', 'Fecha/hora'];
      const filas = registros.map((r, i) => [
        String(i + 1),
        recortarTexto(r.codigo, 26),
        String(r.cantidad),
        recortarTexto(r.serie, 24),
        recortarTexto(r.fecha, 22)
      ]);

      const widths = headers.map((h, i) => Math.max(h.length, ...filas.map(f => f[i].length)));
      const sep = `+-${widths.map(w => '-'.repeat(w)).join('-+-')}-+`;
      const row = (cols) => `| ${cols.map((c, i) => c.padEnd(widths[i], ' ')).join(' | ')} |`;

      return [
        sep,
        row(headers),
        sep,
        ...filas.map(row),
        sep
      ].join('\n');
    }

    function generarTablaHTML() {
      const estiloTabla = 'border-collapse:collapse;width:100%;font-family:Arial,sans-serif;font-size:13px;';
      const estiloCelda = 'border:1px solid #999;padding:6px;text-align:left;';
      const thead = `<tr><th style="${estiloCelda}">#</th><th style="${estiloCelda}">C√≥digo componente</th><th style="${estiloCelda}">Cantidad</th><th style="${estiloCelda}">N¬∫ serie destino</th><th style="${estiloCelda}">Fecha/hora</th></tr>`;
      const rows = registros.map((r, i) =>
        `<tr><td style="${estiloCelda}">${i + 1}</td><td style="${estiloCelda}">${r.codigo}</td><td style="${estiloCelda}">${r.cantidad}</td><td style="${estiloCelda}">${r.serie}</td><td style="${estiloCelda}">${r.fecha}</td></tr>`
      ).join('');
      return `<table style="${estiloTabla}"><thead>${thead}</thead><tbody>${rows}</tbody></table>`;
    }

    $('mailBtn').addEventListener('click', () => {
      if (!registros.length) {
        alert('No hay registros todav√≠a.');
        return;
      }

      const asunto = encodeURIComponent(`Inventario QR (${registros.length} registros)`);
      const tablaTxt = generarTablaTexto();
      const tablaHtml = generarTablaHTML();
      const cuerpoPlano = [
        'Inventario generado por la app de escaneo QR.',
        '',
        'Tabla (texto):',
        tablaTxt,
        '',
        'Tabla HTML (si tu cliente la soporta al pegar/interpretar):',
        tablaHtml
      ].join('\n');

      const cuerpo = encodeURIComponent(cuerpoPlano.slice(0, 1800));
      window.location.href = `mailto:?subject=${asunto}&body=${cuerpo}`;
    });

    function onScanSuccess(decodedText) {
      const ahora = Date.now();
      const duplicadoReciente = decodedText === ultimoCodigo && (ahora - ultimoMomento) < 2500;
      if (modalAbierta || duplicadoReciente) return;

      ultimoCodigo = decodedText;
      ultimoMomento = ahora;
      statusEl.textContent = `QR detectado: ${decodedText}`;
      abrirModal(decodedText);
    }


    function obtenerTrackActivoDelReader() {
      const video = document.querySelector('#reader video');
      const stream = video?.srcObject;
      const track = stream?.getVideoTracks?.()[0];
      return track || null;
    }

    async function aplicarAutoenfoque(track) {
      if (!track?.getCapabilities || !track?.applyConstraints) return false;

      const caps = track.getCapabilities();
      const advanced = [];
      if (Array.isArray(caps.focusMode) && caps.focusMode.includes('continuous')) {
        advanced.push({ focusMode: 'continuous' });
      }
      if (caps.focusDistance) {
        advanced.push({ focusDistance: caps.focusDistance.max });
      }

      if (!advanced.length) return false;

      await track.applyConstraints({ advanced });
      return true;
    }

    async function intentarConfigurarAutoenfoque() {
      for (let i = 0; i < 6; i += 1) {
        const track = obtenerTrackActivoDelReader();
        if (track) {
          try {
            const ok = await aplicarAutoenfoque(track);
            if (ok) {
              statusEl.textContent = 'Autoenfoque activado. Escanea con la c√°mara trasera.';
            }
            return;
          } catch (_) {
            return;
          }
        }
        await new Promise(r => setTimeout(r, 250));
      }
    }

    function esDispositivoIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) ||
        (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    }

    function elegirCamaraTrasera(camaras) {
      const porEtiqueta = camaras.find(c => /(back|rear|environment|trasera)/i.test(c.label || ''));
      return porEtiqueta || camaras[0];
    }

    async function iniciarConFallback(html5QrCode, camaras, config) {
      const camaraPreferida = elegirCamaraTrasera(camaras);
      const intentos = [
        camaraPreferida?.id,
        { facingMode: 'environment' },
        camaras[0]?.id
      ].filter(Boolean);

      let ultimoError;
      for (const objetivo of intentos) {
        try {
          await html5QrCode.start(objetivo, config, onScanSuccess, () => {});
          return;
        } catch (e) {
          ultimoError = e;
        }
      }

      throw ultimoError || new Error('No se pudo iniciar el lector QR.');
    }

    async function iniciarScanner() {
      try {
        const html5QrCode = new Html5Qrcode('reader');
        const cams = await Html5Qrcode.getCameras();
        if (!cams?.length) throw new Error('No se detectaron c√°maras.');

        const esIOS = esDispositivoIOS();
        const configEscaneo = {
          fps: esIOS ? 7 : 10,
          aspectRatio: 1.333,
          experimentalFeatures: { useBarCodeDetectorIfSupported: !esIOS }
        };

        if (!esIOS) {
          configEscaneo.qrbox = { width: 240, height: 240 };
        } else {
          statusEl.textContent = 'Modo iPhone/iPad activado: acerca el QR y mant√©nlo estable 1-2 segundos.';
        }

        await iniciarConFallback(html5QrCode, cams, configEscaneo);
        await intentarConfigurarAutoenfoque();

        scanState.textContent = 'Esc√°ner activo';
        if (!esIOS) {
          statusEl.textContent = 'Esc√°ner activo. Esperando primer QR‚Ä¶';
        }
      } catch (err) {
        scanState.textContent = 'Error de c√°mara';
        statusEl.textContent = `No se pudo abrir la c√°mara: ${err.message || err}`;
      }
    }

    window.addEventListener('load', iniciarScanner);
  </script>
</body>
</html>
